<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- vo alias : "cmainVO" -->
<mapper namespace="foodbuncker.CMainData">

<select id="selectOneTReview" parameterType="int" resultType="cmainVO">
	<![CDATA[
	SELECT
		b_body AS REVIEWBODY,
		b_date AS REVIEWTIME,
		p_placename AS PNAME
	FROM
		(SELECT
			b_body,
			b_date,
			oc_p_no
		FROM
			(SELECT
				b_body,
				b_date,
				b_t_no
			FROM
				board
			WHERE
				b_t_no = #{tno}
			AND
				b_isshow = 'Y'
			ORDER BY
				b_no),
			openclose
		WHERE
			oc_t_no = b_t_no
		AND
			to_date(oc_open,'YYYY/MM/DD') like to_date(b_date,'YYYY/MM/DD')),
			place
		WHERE
			rownum <= 10
		AND
			p_no = oc_p_no
		ORDER BY
			b_date 
		DESC
		
		]]>
	
	 
</select>

<select id="selectCount" parameterType="int" resultType="int">
	SELECT
		COUNT(*)
	FROM
		BOARD
	WHERE
		b_t_no = #{tno}
	AND
		b_isshow = 'Y'
</select>

<select id="selectOneTAllReview" parameterType="hashmap" resultType="cmainVO">
	<![CDATA[
	SELECT
		*
	FROM
		(SELECT
			rownum AS RNO,
			a.*
		FROM
			(SELECT
				b_body AS REVIEWBODY,
				b_date AS REVIEWTIME,
				p_placename AS PNAME
			FROM
				(SELECT
					b_body,
					b_date,
					oc_p_no
				FROM
					(SELECT
						b_body,
						b_date,
						b_t_no
					FROM
						board
					WHERE
						b_t_no = #{tno}
					AND
						b_isshow = 'Y'
					ORDER BY
						b_no),
					openclose
				WHERE
					oc_t_no = b_t_no
				AND
					to_date(oc_open,'YYYY/MM/DD') like to_date(b_date,'YYYY/MM/DD')),
					place
				WHERE
					rownum <= #{end}
				AND
					p_no = oc_p_no
				ORDER BY
					b_date 
				DESC) a)
		WHERE
			RNO BETWEEN #{start} AND #{end}
		
		]]>
</select>

<select id="selectMenuCountRatio" parameterType="int" resultType="cmainVO">
	SELECT
		m_name AS MNAME, 
		round(ratio_to_report(sum(om_num)) over(partition by grouping_id(m_name))*100,2) as RATIO 
	FROM
		menu,
		ordermenu 
	WHERE
		m_t_no=#{tno} 
	AND 
		m_no=om_m_no 
	GROUP BY
		m_name 
</select>

<select id="selectWeekSaleRatio" parameterType="int" resultType="cmainVO">
	SELECT
		WEEKNAME,
		round(ratio_to_report(sum(om_num*m_price)) over(partition by grouping_id(WEEKNAME))*100,2) as RATIO
	FROM
		(SELECT
			WEEKNAME,
			om_m_no,
			om_num
		FROM
			(SELECT
				o_no,
				o_t_no,
				to_char(o_ordtime,'DY') AS WEEKNAME
			FROM
				morder
			WHERE
				o_t_no=#{tno}),
				ordermenu
		WHERE
			o_no=om_o_no),
			menu
	WHERE
		om_m_no = m_no
	GROUP BY
		WEEKNAME
</select>

<select id="selectGenderSaleRatio" parameterType="int" resultType="cmainVO">
	SELECT
		o_gender AS GENDER,
		round(ratio_to_report(sum(om_num*m_price)) over(partition by grouping_id(o_gender))*100,2) as RATIO
	FROM
		(SELECT
			o_gender,
			om_m_no,
			om_num
		FROM
			(SELECT
				o_no,
				o_t_no,
				o_gender
			FROM
				morder
			WHERE
				o_t_no=#{tno}),
				ordermenu
		WHERE
			o_no=om_o_no),
			menu
	WHERE
		om_m_no = m_no
	GROUP BY
		o_gender
		
</select>

<select id="selectAgeSaleRatio" parameterType="int" resultType="cmainVO">
	SELECT
		o_age AS AGE,
		round(ratio_to_report(sum(om_num*m_price)) over(partition by grouping_id(o_age))*100,2) as RATIO
	FROM
		(SELECT
			o_age,
			om_m_no,
			om_num
		FROM
			(SELECT
				o_no,
				o_t_no,
				o_age
			FROM
				morder
			WHERE
				o_t_no=#{tno}),
				ordermenu
		WHERE
			o_no=om_o_no),
			menu
	WHERE
		om_m_no = m_no
	GROUP BY
		o_age
</select>



</mapper>